build:
  server:
    context: .

deploy:
  image: gcr.io/google.com/cloudsdktool/google-cloud-cli:stable
  commands:
  - name: Create Bucket
    command: gcloud storage buckets create gs://test-bucket-${OKTETO_NAMESPACE}
  - name: Deploy the app
    command: helm upgrade --install gcp-app gcp-app --set image=${OKTETO_BUILD_SERVER_IMAGE} --set bucket="test-bucket-${OKTETO_NAMESPACE}"


test:
  gcp:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:stable
    commands:
      - gcloud storage ls | grep test-bucket

destroy:
  image: gcr.io/google.com/cloudsdktool/google-cloud-cli:stable
  commands:
    - gcloud storage buckets delete gs://test-bucket-${OKTETO_NAMESPACE}